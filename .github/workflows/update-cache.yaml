name: Update Cache

on:
  pull_request: []
  workflow_dispatch:
  schedule:
  - cron: 0 0 * * 3

jobs:
  update-cache:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Create conda environment
      run: conda create --quiet -c conda-forge --name shpc spython

    - name: Derive BioContainers List
      run: |
        export PATH="/usr/share/miniconda/bin:$PATH"
        source activate shpc
        pip install git+https://github.com/singularityhub/singularity-hpc@main
        pip install -r .github/scripts/dev-requirements.txt
        python .github/scripts/get_biocontainers.py /tmp/biocontainers.txt
        head /tmp/biocontainers.txt

    - name: Update Cache Action
      uses: singularityhub/container-executable-discovery@main
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        repo-letter-prefix: true
        listing: /tmp/biocontainers/containers.txt
        dry_run: ${{ github.event_name == 'pull_request' }}


